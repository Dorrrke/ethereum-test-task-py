# Тестовое задание Go+Python

## Задание
Разработать два микросервиса, взаимодействующие друг с другом для реализации API сервиса голосования. Общение между ними должно работать через GRPC.

## Библиотеки и технологии
#### Сервиса на Go
1. Golang 1.21.2
2. grpc
3. cleanenv
#### Сервис на Python
1. Python 3.12.1
2. База данных SqLite
3. SqlAlchemy
4. Flask
5. grpc

## Сервис на Go для работы с криптовалютой *Ethereum*
### Методы сервиса
Сервис имеет следующие grpc методы:
* **GetBalance** - получение баланса по ethereum адресу. 
		В качестве аргумента метод получает адрес, и возвращает баланс пользователя по этому адресу в сети ethereum.
* **GetLatestBlock** - получение информации по последнему блоку.
		Метод возвращает номер последнего блока, количество транзакций, сложность блока и время создания.
* **VerifyAddress** - проверка адреса на валидность и то что он не является смарт контрактом.
		В качестве аргумента метод получает адрес, и возвращает Bool переменную в зависимости, является ли адрес валидным или нет.
### Конфигурация сервиса
Сервис конфигурируется через yaml файл со следующей структурой:
```
env: "local"
grpc:
  port: 8080
  timeout: 5s 
```
Путь к файлу должен быть указан либо в переменной окружения `CONFIG_PATH` либо при запуске в флаге `--config`
Для чтения конфигурации из yaml используется библиотека [cleanenv](github.com/ilyakaznacheev/cleanenv).

### Основные пакеты и файлы сервиса
Точкой входа является `ethereumService\cmd\ethereumservice\main.go`. В этом файле происходит конфигурация сервиса посредствам вызова методов конфигурации из пакета *config*. Инициализация логгера slog. Запуск сервиса и реализация Graceful shutdown.

**Файл app.go пакета app**
В пакете инициализируется Ethereum клиент, для работы с которым используется библиотека [go-ethereum]( https://github.com/ethereum/go-ethereum) и инициализация grpc сервера.

**Файл app.go пакета grpc**
В файле реализован запуск и остановка grpc сервера.

**Файл ethereumclient.go**
В файле описаны методы для работы с сетью Ethereum

**Файл server.go**
В файле реализованы методы grpc сервера. Для работы с grpc был написан .proto файл с описанием методов сервиса и сгенерированы файлы для реализации этих методов.



## Сервис на Python в виде REST API
## Методы сервиса
1. Create Proposal - создание **Proposal** (доступно только **Admin**).
2. Update Proposal - редактирование данных **Proposal** (доступно только **Admin**), недоступно если за **Proposal** уже голосовали.
3. Delete Proposal - удаление **Proposal** (доступно только **Admin**), недоступно если за **Proposal** уже голосовали.
4. Get Proposals - получение всех **Proposal**.
5. Register User - регистрация нового пользователя. На вход подается адрес, метод должен проверять адрес на валидность с помощью метода **VerifyAddress** Go сервиса, а также записывать текущий блок в сети на момент регистрации (использовать метод **GetLatestBlock** Go сервиса).
6. Create Vote - запись голоса пользователя за какое-либо предложение. Голос пользователя учитывается, только если его баланс на момент голосования больше 0 (использовать метод **GetBalance** Go сервиса), в противном случае необходимо выдать ошибку. Баланс пользователя и номер текущего блока в сети необходимо записать вместе с голосом.
7. Get Votes - получение суммарной информации о голосовании за конкретное предложение (сумма балансов голосов за и сумма балансов голосов против).

### Основные пакеты и файлы сервиса
* ***app.py**
	Основной файл сервиса. В файле содержатся все методы для работы с ним через http (для создания сервиса использовался фреймворк ***Flask***) и настройка базы данных. Для работы с бд используется библиотека ***sqlalchemy*** схема таблиц описана в файле models.py
	Тк некоторые методы доступны только для администратора, проверка пользователя реализована так:
```python
 userId = request.cookies.get("userId")
    if userId == "":
        return {'message':'user unauthorized'}, 401
    user = User.query.filter(User.uid == userId).first()
    if user.isAdmin != True:
        return {'message':'Not access'}, 403
    try:
        pid = request.json['pid']
    except:
        return '', 400
```
*P.S. В cooke в идеале должен храниться JWT токен, а не id напрямую. Будет исправлено* 

* ***Каталог venv/services/grpc_gen**
В каталоге хранятся сгенерированные по ранее написанному .proto файлу файлы для работы с grpc и общения с сервисом написанном на Go

* Файл grpc_service
В файле находится реализация методов для работы с grpc.

### В планах
1. Реализовать конфигрурацию сервиса
2. Добавить JWT
